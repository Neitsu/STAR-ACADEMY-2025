<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Star Academy — Classements (layout Produce Camp)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    *{box-sizing:border-box}
    :root{
      --bg:#070b12;
      --bg-soft:#111827;
      --bg-softer:#0b1220;
      --border:#1f2937;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --accent:#4f46e5;
      --accent-soft:rgba(79,70,229,.12);
      --accent-strong:#a855f7;
      --danger:#ef4444;
      --gold:#facc15;
      --up:#22c55e;
      --down:#f97316;
      --card-radius:20px;
      --shadow-soft:0 18px 40px rgba(15,23,42,.7)
    }

    /* Thème clair : override des variables + fonds principaux */
    body[data-theme="light"]{
      --bg:#f3f4f6;
      --bg-soft:#ffffff;
      --bg-softer:#e5e7eb;
      --border:#d1d5db;
      --text:#111827;
      --muted:#6b7280;
      --accent:#2563eb;
      --accent-soft:rgba(37,99,235,.1);
      --accent-strong:#7c3aed;
      --danger:#b91c1c;
      --gold:#ca8a04;
      --up:#16a34a;
      --down:#ea580c;
      background:radial-gradient(circle at top,#e5e7eb 0,#f9fafb 55%,#e5e7eb 100%);
      color:var(--text);
    }
    body[data-theme="light"] .card{
      background:linear-gradient(180deg,#ffffff,#f3f4f6);
      border-color:var(--border);
      box-shadow:0 12px 25px rgba(148,163,184,.4);
    }
    body[data-theme="light"] .table-wrapper{
      background:#ffffff;
      border-color:var(--border);
    }
    body[data-theme="light"] thead{
      background:linear-gradient(90deg,#e5e7eb,#f3f4f6);
    }
    body[data-theme="light"] tbody tr,
    body[data-theme="light"] tbody tr:nth-child(2n){
      background:#ffffff;
    }
    body[data-theme="light"] tbody tr:hover{
      background:#e5e7eb;
    }
    body[data-theme="light"] tbody tr.selected{
      background:linear-gradient(90deg,#e0f2fe,#ede9fe);
    }
    body[data-theme="light"] .chart-wrap{
      background:linear-gradient(180deg,#ffffff,#e5e7eb);
      border-color:var(--border);
    }

    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",system-ui,sans-serif;
      background:radial-gradient(circle at top,#1d2537 0,#020617 55%,#000 100%);
      color:var(--text);
      min-height:100vh;
      -webkit-font-smoothing:antialiased
    }
    main{padding:24px 16px 40px}
    .container{max-width:1100px;margin:0 auto;padding:20px}
    .logo{
      font-weight:800;
      letter-spacing:.12em;
      text-transform:uppercase;
      font-size:.9rem;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:10px
    }
    .logo span{
      display:inline-flex;
      padding:4px 10px;
      border-radius:999px;
      background:linear-gradient(120deg,#a855f7,#4f46e5);
      color:#0f172a;
      font-size:.75rem;
      box-shadow:0 12px 30px rgba(88,28,135,.7)
    }
    h1{
      margin:.4rem 0 0;
      font-size:1.9rem;
      letter-spacing:.04em;
      text-transform:uppercase
    }
    .subtitle{
      margin-top:.4rem;
      font-size:.9rem;
      color:var(--muted)
    }
    .subtitle strong{color:var(--gold)}
    .grid{
      display:grid;
      grid-template-columns:2.1fr 1.4fr;
      gap:20px;
      margin-top:24px
    }
    @media(max-width:900px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background:radial-gradient(circle at top left,#1f2937 0,rgba(15,23,42,.9) 55%,#020617 100%);
      border-radius:var(--card-radius);
      border:1px solid rgba(148,163,184,.35);
      box-shadow:var(--shadow-soft);
      padding:18px 18px 16px;
      position:relative;
      overflow:hidden
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:radial-gradient(circle at 0 0,rgba(56,189,248,.08),transparent 55%);
      opacity:.7;
      pointer-events:none
    }
    .card>div,.card>header{position:relative;z-index:1}
    .card header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:12px;
      gap:12px
    }
    .card-title{
      font-size:.95rem;
      font-weight:600;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:#e5e7eb
    }
    body[data-theme="light"] .card-title{color:#111827;}
    .card-subtitle{
      font-size:.8rem;
      color:var(--muted)
    }
    .pill{
      font-size:.7rem;
      text-transform:uppercase;
      letter-spacing:.12em;
      padding:4px 8px;
      border-radius:999px;
      background:rgba(15,23,42,.85);
      border:1px solid rgba(148,163,184,.5);
      display:inline-flex;
      align-items:center;
      gap:4px;
      color:#e5e7eb
    }
    body[data-theme="light"] .pill{
      background:#e5e7eb;
      color:#111827;
      border-color:#cbd5f5;
    }
    .pill span.dot{
      width:7px;
      height:7px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 30%,#22c55e 0,#16a34a 40%,#0f766e 100%);
      box-shadow:0 0 10px rgba(34,197,94,.7)
    }
    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin-bottom:8px
    }
    .toolbar-left{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .toolbar-right{display:flex;flex-wrap:wrap;gap:8px;margin-left:auto}
    .field{
      position:relative;
      display:flex;
      align-items:center;
      border-radius:999px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(55,65,81,.9);
      padding:0 10px;
      min-height:32px;
      font-size:.8rem;
      color:var(--muted);
      gap:6px
    }
    body[data-theme="light"] .field{
      background:#f9fafb;
      border-color:#d1d5db;
      color:#6b7280;
    }
    .field input,.field select{
      background:transparent;
      border:none;
      outline:none;
      color:inherit;
      font:inherit
    }
    .field input::placeholder{color:#6b7280}
    .btn{
      border-radius:999px;
      border:1px solid rgba(148,163,184,.7);
      background:rgba(15,23,42,.9);
      color:#e5e7eb;
      padding:6px 12px;
      font-size:.75rem;
      font-weight:500;
      text-transform:uppercase;
      letter-spacing:.12em;
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      transition:background .15s ease,border-color .15s ease,transform .1s ease
    }
    .btn-ghost{background:transparent;border-color:rgba(51,65,85,.9);color:var(--muted)}
    .btn-primary{
      background:linear-gradient(135deg,#4f46e5,#7c3aed);
      border-color:rgba(129,140,248,.9);
      color:#e5e7eb;
      box-shadow:0 10px 25px rgba(55,48,163,.7)
    }
    .btn:hover{transform:translateY(-1px);border-color:#e5e7eb}
    .btn-primary:hover{background:linear-gradient(135deg,#6366f1,#a855f7)}
    body[data-theme="light"] .btn-ghost{
      border-color:#d1d5db;
      color:#4b5563;
    }
    body[data-theme="light"] .btn-primary{
      background:linear-gradient(135deg,#2563eb,#7c3aed);
      color:#f9fafb;
    }
    .seg{
      display:inline-flex;
      background:rgba(15,23,42,.9);
      border-radius:999px;
      border:1px solid rgba(55,65,81,.9);
      padding:2px
    }
    .seg button{
      border:none;
      background:transparent;
      color:var(--muted);
      font-size:.75rem;
      text-transform:uppercase;
      letter-spacing:.12em;
      padding:4px 9px;
      border-radius:999px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:4px;
      min-width:0
    }
    .seg button.active{
      background:rgba(79,70,229,.15);
      color:#e5e7eb
    }
    body[data-theme="light"] .seg{
      background:#f3f4f6;
      border-color:#d1d5db;
    }
    body[data-theme="light"] .seg button.active{
      background:#e5e7eb;
      color:#111827;
    }

    .table-wrapper{
      margin-top:10px;
      border-radius:16px;
      border:1px solid rgba(31,41,55,.95);
      background:radial-gradient(circle at top,#020617 0,#020617 50%,#000 100%);
      overflow-x:auto;
      overflow-y:hidden;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:.8rem;
      min-width:900px;
    }
    thead{
      background:linear-gradient(90deg,rgba(15,23,42,.98),rgba(17,24,39,.98));
      position:relative
    }
    thead::after{
      content:"";
      position:absolute;
      inset:0;
      background:radial-gradient(circle at 0 0,rgba(129,140,248,.18),transparent 55%);
      opacity:.7;
      pointer-events:none
    }
    thead th{
      text-align:left;
      font-weight:500;
      padding:8px 10px;
      border-bottom:1px solid rgba(55,65,81,.95);
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.12em;
      font-size:.68rem;
      white-space:nowrap
    }
    thead th.num{
      text-align:center;
    }

    /* Colonnes figées (# + Élève) */
    th.sticky-rank{
      position:sticky;
      left:0;
      z-index:5;
      background:inherit;
    }
    th.sticky-col{
      position:sticky;
      left:50px; /* largeur de la colonne # */
      z-index:4;
      background:inherit;
    }

    tbody tr{
      border-bottom:1px solid rgba(31,41,55,.85);
      background:linear-gradient(90deg,rgba(15,23,42,.92),rgba(15,23,42,.9));
      cursor:pointer;
      transition:background .12s ease,transform .06s ease
    }
    tbody tr:nth-child(2n){background:linear-gradient(90deg,rgba(15,23,42,.92),rgba(15,23,42,.94))}
    tbody tr:hover{background:rgba(30,64,175,.35)}
    tbody tr.selected{
      background:radial-gradient(circle at 0 0,rgba(129,140,248,.45),rgba(30,64,175,.85));
      transform:translateY(-1px)
    }
    tbody td{
      padding:7px 10px;
      vertical-align:middle
    }
    td.rank{
      width:50px;
      font-weight:600;
      color:var(--muted);
      font-variant-numeric:tabular-nums;
      text-align:center;
    }
    td.rank.sticky-rank{
      position:sticky;
      left:0;
      z-index:3;
      background:inherit;
    }
    td.num{
      text-align:center;
      font-variant-numeric:tabular-nums;
    }
    td.name{
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:500;
      position:relative;
      z-index:3;
      white-space:nowrap;
    }
    td.name.sticky-col{
      position:sticky;
      left:50px;
      background:inherit;
      box-shadow:8px 0 12px rgba(15,23,42,.9);
    }
    body[data-theme="light"] td.name.sticky-col{
      box-shadow:8px 0 12px rgba(209,213,219,.9);
    }
    .avatar{
      width:26px;
      height:26px;
      border-radius:999px;
      object-fit:cover;
      border:1px solid rgba(148,163,184,.75);
      box-shadow:0 6px 16px rgba(15,23,42,.8)
    }
    .chip{
      display:inline-flex;
      align-items:center;
      padding:2px 7px;
      border-radius:999px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(55,65,81,.9);
      font-size:.7rem;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--muted)
    }
    body[data-theme="light"] .chip{
      background:#f3f4f6;
      border-color:#d1d5db;
      color:#6b7280;
    }
    .chip.elim{
      border-color:rgba(248,113,113,.7);
      color:#fecaca;
      background:rgba(127,29,29,.7)
    }
    .delta{
      font-variant-numeric:tabular-nums;
      white-space:nowrap;
      font-size:.75rem;
      color:var(--muted);
      margin-left:6px;
    }
    .delta.up{color:var(--up)}
    .delta.down{color:var(--down)}
    .mini{
      margin-top:14px;
      font-size:.75rem;
      color:var(--muted);
      line-height:1.4
    }
    .profile{
      display:flex;
      flex-direction:column;
      gap:12px
    }
    .profile-main{
      display:flex;
      gap:12px;
      align-items:center
    }
    .profile-pic-wrap{
      position:relative;
      width:88px;
      height:88px;
      border-radius:24px;
      padding:2px;
      background:conic-gradient(from 210deg,#4f46e5,#a855f7,#22c55e,#4f46e5);
      box-shadow:0 18px 45px rgba(15,23,42,.9)
    }
    .profile-pic-inner{
      position:relative;
      width:100%;
      height:100%;
      border-radius:inherit;
      overflow:hidden;
      background:radial-gradient(circle at top,#1f2937,#020617)
    }
    .profile-pic-inner img{
      width:100%;
      height:100%;
      object-fit:cover
    }
    .profile-text h2{
      margin:0;
      font-size:1.1rem;
      letter-spacing:.04em;
      text-transform:uppercase
    }
    .profile-text p{
      margin:2px 0 0;
      color:var(--muted);
      font-size:.8rem
    }
    .badge-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px
    }
    .badge{
      font-size:.7rem;
      padding:3px 7px;
      border-radius:999px;
      border:1px solid rgba(55,65,81,.9);
      background:rgba(15,23,42,.9);
      color:var(--muted)
    }
    .badge.gold{
      border-color:rgba(250,204,21,.7);
      color:var(--gold);
      background:rgba(23,37,84,.9)
    }
    body[data-theme="light"] .badge{
      background:#f3f4f6;
      border-color:#d1d5db;
      color:#4b5563;
    }
    body[data-theme="light"] .badge.gold{
      background:#fef3c7;
      border-color:#fbbf24;
      color:#92400e;
    }
    .chart-wrap{
      margin-top:6px;
      border-radius:16px;
      border:1px solid rgba(31,41,55,.9);
      background:radial-gradient(circle at top,#020617,#000);
      padding:10px;
      height:260px;
      position:relative
    }
    .chart-wrap::before{
      content:"";
      position:absolute;
      inset:0;
      background:radial-gradient(circle at 20% 0,rgba(59,130,246,.22),transparent 55%);
      opacity:.7;
      pointer-events:none
    }
    .chart-wrap>canvas{position:relative;z-index:1}
    .sr{
      position:absolute;
      width:1px;
      height:1px;
      padding:0;
      margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      white-space:nowrap;
      border:0
    }
  </style>
</head>
<body data-theme="dark">
  <main>
    <header class="container">
      <div class="logo">
        <span>Star Academy</span>
        Dashboard primes
      </div>
      <h1>Classements croisés</h1>
      <p class="subtitle">
        Vue type <strong>Produce Camp</strong> : classements <strong>perso</strong>, <strong>profs</strong>,
        <strong>popularité</strong> et une vue <strong>fusion</strong>.
      </p>
    </header>

    <div class="container">
      <div class="grid">
        <!-- COLONNE GAUCHE : TABLEAU -->
        <div class="card">
          <header>
            <div>
              <div class="card-title">Top élèves</div>
              <div class="card-subtitle">Filtre par prime, source et promo.</div>
            </div>
            <div class="pill">
              <span class="dot"></span>
              Live ranking
            </div>
          </header>

          <div class="toolbar">
            <div class="toolbar-left">
              <div class="field" style="min-width:190px">
                <input id="q" type="search" placeholder="Rechercher un·e élève…" />
              </div>

              <label class="sr" for="promo">Promo</label>
              <select id="promo" aria-label="Filtrer par promo"></select>

              <label class="sr" for="prime">Prime</label>
              <select id="prime" aria-label="Prime active">
                <option value="auto">Auto (dernière)</option>
                <option value="0">Prime 0</option>
                <option value="1">Prime 1</option>
                <option value="2">Prime 2</option>
                <option value="3">Prime 3</option>
                <option value="4">Prime 4</option>
              </select>

              <div class="seg" role="tablist" aria-label="Source du classement">
                <button type="button" data-view="perso" role="tab" aria-selected="true" class="active">
                  Perso
                </button>
                <button type="button" data-view="profs" role="tab" aria-selected="false">
                  Profs
                </button>
                <button type="button" data-view="pop" role="tab" aria-selected="false">
                  Popu
                </button>
                <button type="button" data-view="fusion" role="tab" aria-selected="false">
                  Fusion
                </button>
              </div>
            </div>

            <div class="toolbar-right">
              <button id="sortBtn" class="btn btn-ghost" type="button">
                Trier par nom
              </button>
              <button id="share" class="btn btn-primary" type="button">
                Copier le lien
              </button>
              <button id="themeToggle" class="btn btn-ghost" type="button">
                Mode clair
              </button>
            </div>
          </div>

          <div class="table-wrapper">
            <table id="top">
              <thead>
                <tr>
                  <th class="sticky-rank">#</th>
                  <th class="sticky-col">Élève</th>
                  <th class="num">Prime 0</th>
                  <th class="num">Prime 1</th>
                  <th class="num">Prime 2</th>
                  <th class="num">Prime 3</th>
                  <th class="num">Prime 4</th>
                  <th class="num">Moyenne</th>
                </tr>
              </thead>
              <tbody id="topBody"></tbody>
            </table>
          </div>
        </div>

        <!-- COLONNE DROITE : PROFIL + GRAPHIQUE -->
        <div class="card">
          <header>
            <div>
              <div class="card-title">Fiche élève & courbe</div>
              <div class="card-subtitle">Clique sur un·e élève pour voir sa trajectoire.</div>
            </div>
          </header>

          <div class="profile">
            <div class="profile-main">
              <div class="profile-pic-wrap">
                <div class="profile-pic-inner">
                  <img id="pic" src="assets/placeholder.jpg" alt="Élève sélectionné" />
                </div>
              </div>
              <div class="profile-text">
                <h2 id="infoName">Sélectionne un·e élève</h2>
                <p id="infoPromo">Promo —</p>
                <div class="badge-row">
                  <span class="badge gold">Prime active</span>
                  <span class="badge">Perso / Profs / Popu / Fusion</span>
                </div>
                <p id="infoExtra" style="margin-top:6px;font-size:.8rem;color:var(--muted);max-width:260px;">
                  Rang, moyenne et statut d'élimination s'afficheront ici.
                </p>
              </div>
            </div>

            <div class="chart-wrap">
              <canvas id="chartLine"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer class="container">
      <p class="mini">
        Δ places = différence de rang par rapport à la prime précédente (▲ = mieux, ▼ = pire).
        Clique sur un·e élève pour surligner sa courbe.
      </p>
    </footer>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
  (() => {
    "use strict";

    /*********************************
     * 1. Données de classement
     *********************************/
    const P0_PERSO = {
      "Ambre": 4, "Anouk": 2, "Bastiaan": 10, "Ema": 16, "Jeanne": 9,
      "Lea": 5, "Léane": 13, "Lenny": 12, "Leo": 6, "Lily": 8,
      "Mehdi": 14, "Melissa": 7, "Noah": 11, "Sarah": 3,
      "Théo L.": 15, "Théo P.": 17, "Victor": 1
    };
    const P0_PROFS = {
      "Ambre": 5, "Anouk": 3, "Bastiaan": 7, "Ema": 16, "Jeanne": 9,
      "Lea": 4, "Léane": 10, "Lenny": 16, "Leo": 8, "Lily": 6,
      "Mehdi": 10, "Melissa": 10, "Noah": 14, "Sarah": 2,
      "Théo L.": 14, "Théo P.": 10, "Victor": 1
    };

    // PRIME 1
    const P1_PERSO = {
      "Ambre": 4, "Anouk": 3, "Bastiaan": 8, "Ema": 14, "Jeanne": 5,
      "Lea": 7, "Léane": 6, "Lenny": 13, "Leo": 9, "Lily": 17,
      "Mehdi": 11, "Melissa": 10, "Noah": 16, "Sarah": 2,
      "Théo L.": 12, "Théo P.": 15, "Victor": 1
    };
    const P1_PROFS = {
      "Ambre": 7, "Anouk": 6, "Bastiaan": 10, "Ema": 15, "Jeanne": 2,
      "Lea": 4, "Léane": 9, "Lenny": 7, "Leo": 12, "Lily": 5,
      "Mehdi": 15, "Melissa": 12, "Noah": 10, "Sarah": 3,
      "Théo L.": 12, "Théo P.": 17, "Victor": 1
    };
    const P1_POP = {
      "Ambre": 1, "Anouk": 2, "Bastiaan": 15, "Ema": 11, "Jeanne": 6,
      "Lea": 11, "Léane": 13, "Lenny": 17, "Leo": 3, "Lily": 14,
      "Mehdi": 16, "Melissa": 6, "Noah": 9, "Sarah": 3,
      "Théo L.": 10, "Théo P.": 8, "Victor": 5
    };

    // PRIME 2
    const P2_PERSO = {
      "Ambre": 3, "Anouk": 2, "Bastiaan": 6, "Ema": 16, "Jeanne": 5,
      "Lea": 15, "Léane": 8, "Lenny": 9, "Leo": 12, "Lily": 14,
      "Mehdi": null, "Melissa": 10, "Noah": 7, "Sarah": 1,
      "Théo L.": 11, "Théo P.": 13, "Victor": 4
    };
    const P2_PROFS = {
      "Ambre": 2, "Anouk": 4, "Bastiaan": 10, "Ema": 15, "Jeanne": 4,
      "Lea": 6, "Léane": 7, "Lenny": 16, "Leo": 11, "Lily": 9,
      "Mehdi": null, "Melissa": 8, "Noah": 14, "Sarah": 1,
      "Théo L.": 13, "Théo P.": 11, "Victor": 3
    };
    const P2_POP = {
      "Ambre": 2, "Anouk": 3, "Bastiaan": 15, "Ema": 13, "Jeanne": 1,
      "Lea": 5, "Léane": 8, "Lenny": 15, "Leo": 6, "Lily": 13,
      "Mehdi": null, "Melissa": 10, "Noah": 12, "Sarah": 4,
      "Théo L.": 8, "Théo P.": 10, "Victor": 7
    };

    // PRIME 3
    const P3_PERSO = {
      "Ambre": 3, "Anouk": 2, "Bastiaan": 9, "Ema": 15, "Jeanne": 5,
      "Lea": 14, "Léane": 8, "Lenny": null, "Leo": 11, "Lily": 13,
      "Mehdi": null, "Melissa": 6, "Noah": 7, "Sarah": 1,
      "Théo L.": 10, "Théo P.": 12, "Victor": 4
    };
    const P3_PROFS = {
      "Ambre": 10, "Anouk": 5, "Bastiaan": 1, "Ema": 1, "Jeanne": 5,
      "Lea": 1, "Léane": 5, "Lenny": null, "Leo": 10, "Lily": 1,
      "Mehdi": null, "Melissa": 10, "Noah": 10, "Sarah": 10,
      "Théo L.": 5, "Théo P.": 5, "Victor": 1
    };
    const P3_POP = {
      "Ambre": 1, "Anouk": 2, "Bastiaan": 11, "Ema": 15, "Jeanne": 4,
      "Lea": 11, "Léane": 9, "Lenny": null, "Leo": 5, "Lily": 13,
      "Mehdi": null, "Melissa": 13, "Noah": 6, "Sarah": 3,
      "Théo L.": 8, "Théo P.": 9, "Victor": 6
    };

    // PRIME 4
    const P4_PERSO = {
      "Ambre": 3, "Anouk": 1, "Bastiaan": 8, "Ema": 14, "Jeanne": 6,
      "Lea": 13, "Léane": 7, "Lenny": null, "Leo": 10, "Lily": 11,
      "Mehdi": null, "Melissa": 4, "Noah": null, "Sarah": 2,
      "Théo L.": 9, "Théo P.": 12, "Victor": 5
    };
    const P4_PROFS = {
      "Ambre": 7, "Anouk": 7, "Bastiaan": 2, "Ema": 13, "Jeanne": 6,
      "Lea": 8, "Léane": 12, "Lenny": null, "Leo": 11, "Lily": 10,
      "Mehdi": null, "Melissa": 3, "Noah": null, "Sarah": 4,
      "Théo L.": 14, "Théo P.": 5, "Victor": 8
    };
    const P4_POP = {
      "Ambre": 1, "Anouk": 1, "Bastiaan": 12, "Ema": 13, "Jeanne": 3,
      "Lea": 11, "Léane": 7, "Lenny": null, "Leo": 5, "Lily": 13,
      "Mehdi": null, "Melissa": 6, "Noah": null, "Sarah": 4,
      "Théo L.": 7, "Théo P.": 10, "Victor": 7
    };

    const baseEleves = [
      { id: 1,  nom: "Ambre",   promo: "2025", img: "assets/ambre.jpg",   eliminatedAt: null },
      { id: 2,  nom: "Anouk",   promo: "2025", img: "assets/anouk.jpg",   eliminatedAt: null },
      { id: 3,  nom: "Bastiaan",promo: "2025", img: "assets/bastiaan.jpg",eliminatedAt: null },
      { id: 4,  nom: "Ema",     promo: "2025", img: "assets/ema.jpg",     eliminatedAt: 4 },
      { id: 5,  nom: "Jeanne",  promo: "2025", img: "assets/jeanne.jpg",  eliminatedAt: null },
      { id: 6,  nom: "Lea",     promo: "2025", img: "assets/lea.jpg",     eliminatedAt: null },
      { id: 7,  nom: "Léane",   promo: "2025", img: "assets/leane.jpg",   eliminatedAt: null },
      { id: 8,  nom: "Lenny",   promo: "2025", img: "assets/lenny.jpg",   eliminatedAt: 2 },
      { id: 9,  nom: "Leo",     promo: "2025", img: "assets/leo.jpg",     eliminatedAt: null },
      { id:10,  nom: "Lily",    promo: "2025", img: "assets/lily.jpg",    eliminatedAt: null },
      { id:11,  nom: "Mehdi",   promo: "2025", img: "assets/mehdi.jpg",   eliminatedAt: 1 },
      { id:12,  nom: "Melissa", promo: "2025", img: "assets/melissa.jpg", EliminatedAt: null },
      { id:13,  nom: "Noah",    promo: "2025", img: "assets/noah.jpg",    eliminatedAt: 3 },
      { id:14,  nom: "Sarah",   promo: "2025", img: "assets/sarah.jpg",   eliminatedAt: null },
      { id:15,  nom: "Théo L.", promo: "2025", img: "assets/theo_l.jpg",  EliminatedAt: null },
      { id:16,  nom: "Théo P.", promo: "2025", img: "assets/theo_p.jpg",  eliminatedAt: null },
      { id:17,  nom: "Victor",  promo: "2025", img: "assets/victor.jpg",  eliminatedAt: null }
    ];

    const eleves = baseEleves.map(e => ({
      ...e,
      perso: {
        p0: P0_PERSO[e.nom] ?? null,
        p1: P1_PERSO[e.nom] ?? null,
        p2: P2_PERSO[e.nom] ?? null,
        p3: P3_PERSO[e.nom] ?? null,
        p4: P4_PERSO[e.nom] ?? null
      },
      profs: {
        p0: P0_PROFS[e.nom] ?? null,
        p1: P1_PROFS[e.nom] ?? null,
        p2: P2_PROFS[e.nom] ?? null,
        p3: P3_PROFS[e.nom] ?? null,
        p4: P4_PROFS[e.nom] ?? null
      },
      pop: {
        p0: null,
        p1: P1_POP[e.nom] ?? null,
        p2: P2_POP[e.nom] ?? null,
        p3: P3_POP[e.nom] ?? null,
        p4: P4_POP[e.nom] ?? null
      }
    }));

    /*********************************
     * Helpers
     *********************************/
    const fmt = (n) => {
      if (n == null) return "—";
      const v = Number(n);
      return Number.isInteger(v) ? v.toString() : v.toFixed(1);
    };
    const uniq = (arr) => [...new Set(arr)];
    const primeToNum = (p) => ({ "0":0,"1":1,"2":2,"3":3,"4":4 }[p] ?? null);
    const mean = (arr) => {
      const vals = arr.filter(v => v != null).map(Number);
      if (!vals.length) return null;
      return vals.reduce((a,b)=>a+b,0)/vals.length;
    };
    const getLabelList = () => ["Prime 0","Prime 1","Prime 2","Prime 3","Prime 4"];
    const maxAvailablePrime = () => 4;

    /*********************************
     * URL params
     *********************************/
    function readParamsFromURL() {
      const p = new URLSearchParams(location.search);
      return {
        view:  p.get("view")  || "perso",
        q:     p.get("q")     || "",
        promo: p.get("promo") || "all",
        prime: p.get("prime") || "auto",
        sort:  p.get("sort")  || "rank"
      };
    }
    function writeParamsToURL(state) {
      const p = new URLSearchParams();
      if (state.view  && state.view  !== "perso") p.set("view",  state.view);
      if (state.q)                                     p.set("q",     state.q);
      if (state.promo && state.promo !== "all")       p.set("promo", state.promo);
      if (state.prime && state.prime !== "auto")      p.set("prime", state.prime);
      if (state.sort  && state.sort  !== "rank")      p.set("sort",  state.sort);
      const url = location.pathname + "?" + p.toString();
      history.replaceState(null,"",url);
    }

    /*********************************
     * Calculs
     *********************************/
    function sourceForView(eleve, view) {
      if (view === "perso") return eleve.perso;
      if (view === "profs") return eleve.profs;
      if (view === "pop")   return eleve.pop;
      // fusion
      return {
        p0: mean([eleve.perso.p0, eleve.profs.p0]),
        p1: mean([eleve.perso.p1, eleve.profs.p1, eleve.pop.p1]),
        p2: mean([eleve.perso.p2, eleve.profs.p2, eleve.pop.p2]),
        p3: mean([eleve.perso.p3, eleve.profs.p3, eleve.pop.p3]),
        p4: mean([eleve.perso.p4, eleve.profs.p4, eleve.pop.p4])
      };
    }

    function averageUpTo(src, upto) {
      const arr = [];
      if (upto >= 0) arr.push(src.p0);
      if (upto >= 1) arr.push(src.p1);
      if (upto >= 2) arr.push(src.p2);
      if (upto >= 3) arr.push(src.p3);
      if (upto >= 4) arr.push(src.p4);
      return mean(arr);
    }

    function fusionMeanUpTo(eleve, upto) {
      const vals = [];
      if (upto >= 0) vals.push(eleve.perso.p0, eleve.profs.p0);
      if (upto >= 1) vals.push(eleve.perso.p1, eleve.profs.p1, eleve.pop.p1);
      if (upto >= 2) vals.push(eleve.perso.p2, eleve.profs.p2, eleve.pop.p2);
      if (upto >= 3) vals.push(eleve.perso.p3, eleve.profs.p3, eleve.pop.p3);
      if (upto >= 4) vals.push(eleve.perso.p4, eleve.profs.p4, eleve.pop.p4);
      return mean(vals);
    }

    function computeRows(list, view, primeNum) {
      return list
        .map(eleve => {
          const src = sourceForView(eleve, view);
          const moy = (view === "fusion")
            ? fusionMeanUpTo(eleve, primeNum)
            : averageUpTo(src, primeNum);

          return {
            ...eleve,
            p0: src.p0 ?? null,
            p1: src.p1 ?? null,
            p2: src.p2 ?? null,
            p3: src.p3 ?? null,
            p4: src.p4 ?? null,
            moy
          };
        })
        .sort((a,b) => {
          const av = (a.moy == null ? Infinity : a.moy);
          const bv = (b.moy == null ? Infinity : b.moy);
          if (av !== bv) return av - bv;
          const al = [a.p4,a.p3,a.p2,a.p1,a.p0].find(v => v != null) ?? Infinity;
          const bl = [b.p4,b.p3,b.p2,b.p1,b.p0].find(v => v != null) ?? Infinity;
          if (al !== bl) return al - bl;
          return a.nom.localeCompare(b.nom);
        })
        .map((row,i) => ({ ...row, rank: i+1 }));
    }

    function compute(list, prime, view) {
      const maxP = maxAvailablePrime();
      let pNow = primeToNum(prime);
      if (pNow == null) pNow = maxP;
      const pPrev = (pNow > 0) ? pNow - 1 : null;

      const rowsNow = computeRows(list, view, pNow);

      const rankPrevMap = new Map();
      if (pPrev != null) {
        const rowsPrev = computeRows(list, view, pPrev);
        rowsPrev.forEach(r => rankPrevMap.set(r.id, r.rank));
      }

      return rowsNow.map(r => {
        const prevRank    = rankPrevMap.get(r.id);
        const deltaPlaces = (prevRank != null) ? (prevRank - r.rank) : 0;
        return {
          ...r,
          eliminated: (r.eliminatedAt != null && pNow >= r.eliminatedAt),
          deltaPlaces
        };
      });
    }

    /*********************************
     * DOM & rendu
     *********************************/
    const dom = {
      inputSearch: document.getElementById("q"),
      promoSelect: document.getElementById("promo"),
      primeSelect: document.getElementById("prime"),
      sortBtn:     document.getElementById("sortBtn"),
      shareBtn:    document.getElementById("share"),
      themeToggle: document.getElementById("themeToggle"),
      tabs:        Array.from(document.querySelectorAll(".seg [role='tab']")),
      tbody:       document.getElementById("topBody"),
      pic:         document.getElementById("pic"),
      infoName:    document.getElementById("infoName"),
      infoPromo:   document.getElementById("infoPromo"),
      infoExtra:   document.getElementById("infoExtra"),
      chartCanvas: document.getElementById("chartLine")
    };

    const appState = {
      ...readParamsFromURL(),
      nameAsc: false
    };

    let chartLine = null;
    let selectedId = null;
    appState.nameAsc = (appState.sort === "name");

    /********* Thème jour / nuit *********/
    function applyTheme(theme){
      document.body.dataset.theme = theme;
      if (dom.themeToggle){
        dom.themeToggle.textContent = theme === "dark" ? "Mode clair" : "Mode sombre";
      }
      try{
        localStorage.setItem("staracTheme", theme);
      }catch(e){}
    }
    function initTheme(){
      let saved = null;
      try{
        saved = localStorage.getItem("staracTheme");
      }catch(e){}
      const theme = saved === "light" || saved === "dark" ? saved : "dark";
      applyTheme(theme);
    }

    function initPromosSelect() {
      const promos = ["all", ...uniq(eleves.map(e => e.promo))];
      dom.promoSelect.innerHTML = promos
        .map(p => `<option value="${p}">${p === "all" ? "Toutes promos" : p}</option>`)
        .join("");
      dom.promoSelect.value = appState.promo;
    }

    function setActiveTab(view) {
      dom.tabs.forEach(btn => {
        const isActive = btn.dataset.view === view;
        btn.classList.toggle("active", isActive);
        btn.setAttribute("aria-selected", isActive ? "true" : "false");
      });
    }

    function initInputsFromState() {
      dom.inputSearch.value = appState.q;
      dom.primeSelect.value = appState.prime;
      setActiveTab(appState.view);
    }

    function getFilteredBaseList() {
      let list = [...eleves];
      if (appState.promo !== "all") {
        list = list.filter(e => String(e.promo) === String(appState.promo));
      }
      if (appState.q) {
        const q = appState.q.toLowerCase();
        list = list.filter(e => e.nom.toLowerCase().includes(q));
      }
      return list;
    }

    function renderTable(rows, prime) {
      dom.tbody.innerHTML = "";
      rows.forEach(r => {
        const tr = document.createElement("tr");
        tr.dataset.id = r.id;
        if (r.eliminated) tr.classList.add("row-elim");

        const elimBadge = r.eliminated
          ? ' <span class="chip elim">Éliminé</span>'
          : "";

        const deltaClass  = r.deltaPlaces>0 ? "up" : r.deltaPlaces<0 ? "down" : "";
        const deltaSymbol = r.deltaPlaces>0 ? "▲" : r.deltaPlaces<0 ? "▼" : "•";
        const deltaText   = Math.abs(r.deltaPlaces);

        tr.innerHTML = `
          <td class="rank sticky-rank">${r.rank}</td>
          <td class="name sticky-col">
            <img alt="${r.nom}" class="avatar" src="${r.img}" onerror="this.src='assets/placeholder.jpg'"/>
            <span>${r.nom}${elimBadge}</span>
            <span class="delta ${deltaClass}">
              ${deltaSymbol} ${deltaText}
            </span>
          </td>
          <td class="num">${fmt(r.p0)}</td>
          <td class="num">${fmt(r.p1)}</td>
          <td class="num">${fmt(r.p2)}</td>
          <td class="num">${fmt(r.p3)}</td>
          <td class="num">${fmt(r.p4)}</td>
          <td class="num"><strong>${fmt(r.moy)}</strong></td>
        `;
        dom.tbody.appendChild(tr);
      });

      const idx =
        prime === "0" ? 2 :
        prime === "1" ? 3 :
        prime === "2" ? 4 :
        prime === "3" ? 5 :
        prime === "4" ? 6 : null;

      document.querySelectorAll("#top thead th").forEach((th,i) => {
        th.style.color = (i === idx) ? "var(--gold)" : "var(--muted)";
      });
    }

    function updateProfile(eleve, row) {
      if (!eleve) {
        dom.pic.src = "assets/placeholder.jpg";
        dom.infoName.textContent  = "Aucun élève";
        dom.infoPromo.textContent = "";
        dom.infoExtra.textContent = "";
        return;
      }
      dom.pic.src = eleve.img || "assets/placeholder.jpg";
      dom.pic.onerror = () => { dom.pic.src = "assets/placeholder.jpg"; };

      dom.infoName.textContent  = eleve.nom;
      dom.infoPromo.textContent = "Promo " + eleve.promo;

      const status = eleve.eliminatedAt
        ? `Éliminé·e à la prime ${eleve.eliminatedAt}`
        : "Encore en course";

      const moyTxt  = row ? fmt(row.moy)  : "—";
      const rankTxt = row ? row.rank      : "—";

      dom.infoExtra.innerHTML = `
        Rang actuel : <strong>${rankTxt}</strong> •
        Moyenne : <strong>${moyTxt}</strong> •
        ${status}
      `;
    }

    function buildGlobalChart(baseList, view) {
      const labels = getLabelList();
      const sorted = [...baseList].sort((a,b)=>a.nom.localeCompare(b.nom));

      const datasets = sorted.map((e,idx) => {
        const src = sourceForView(e, view);
        const data = [src.p0,src.p1,src.p2,src.p3,src.p4].map(v => v==null?null:Number(v));
        const hue = (idx*37)%360;
        const strong = `hsl(${hue} 80% 60%)`;
        const faint  = `hsla(${hue},80%,60%,0.18)`;
        return {
          label:e.nom,
          data,
          tension:0.3,
          spanGaps:true,
          pointRadius:2,
          pointHitRadius:6,
          borderWidth:1,
          borderColor:faint,
          backgroundColor:faint,
          _id:e.id,
          _strongColor:strong,
          _faintColor:faint
        };
      });

      if (chartLine) chartLine.destroy();

      chartLine = new Chart(dom.chartCanvas.getContext("2d"), {
        type:"line",
        data:{ labels, datasets },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          scales:{
            y:{
              reverse:true,
              suggestedMin:1,
              ticks:{ precision:0, callback:v=>v },
              title:{ display:true, text:"Rang (1 = meilleur)" }
            }
          },
          plugins:{
            legend:{ display:false },
            tooltip:{
              callbacks:{
                label:(ctx)=>`${ctx.dataset.label} : rang ${ctx.parsed.y}`
              }
            }
          }
        }
      });

      if (selectedId != null) highlightDataset(selectedId);
    }

    function highlightDataset(id) {
      if (!chartLine) return;
      selectedId = id;
      chartLine.data.datasets.forEach(ds => {
        if (id == null) {
          ds.borderColor   = ds._faintColor;
          ds.backgroundColor = ds._faintColor;
          ds.borderWidth   = 1;
          ds.pointRadius   = 2;
        } else if (ds._id === id) {
          ds.borderColor   = ds._strongColor;
          ds.backgroundColor = ds._strongColor;
          ds.borderWidth   = 3;
          ds.pointRadius   = 5;
        } else {
          ds.borderColor   = ds._faintColor;
          ds.backgroundColor = ds._faintColor;
          ds.borderWidth   = 1;
          ds.pointRadius   = 2;
        }
      });
      chartLine.update("none");
    }

    function selectRowById(id, rows) {
      dom.tbody.querySelectorAll("tr").forEach(tr => {
        tr.classList.toggle("selected", Number(tr.dataset.id) === id);
      });
      const eleve = eleves.find(e => e.id === id);
      const row   = rows.find(r => r.id === id);
      updateProfile(eleve, row);
      highlightDataset(id);
    }

    /*********************************
     * Cycle principal
     *********************************/
    function apply() {
      const baseList = getFilteredBaseList();
      let rows = compute(baseList, appState.prime, appState.view);

      if (appState.nameAsc) {
        rows = rows
          .slice()
          .sort((a,b)=>a.nom.localeCompare(b.nom))
          .map((x,i)=>({ ...x, rank:i+1 }));
      }

      renderTable(rows, appState.prime);
      buildGlobalChart(baseList, appState.view);

      writeParamsToURL({
        ...appState,
        sort: appState.nameAsc ? "name" : "rank"
      });

      if (rows.length) {
        selectRowById(rows[0].id, rows);
      } else {
        selectedId = null;
        highlightDataset(null);
        updateProfile(null,null);
      }
    }

    /*********************************
     * Événements
     *********************************/
    function bindEvents() {
      dom.inputSearch.addEventListener("input", e => {
        appState.q = e.target.value;
        apply();
      });
      dom.promoSelect.addEventListener("change", e => {
        appState.promo = e.target.value;
        apply();
      });
      dom.primeSelect.addEventListener("change", e => {
        appState.prime = e.target.value;
        apply();
      });
      dom.sortBtn.addEventListener("click", () => {
        appState.nameAsc = !appState.nameAsc;
        apply();
      });
      dom.shareBtn.addEventListener("click", async () => {
        const url = location.href;
        try {
          await navigator.clipboard.writeText(url);
          alert("Lien copié !");
        } catch {
          prompt("Copie le lien :", url);
        }
      });
      dom.tabs.forEach(btn => {
        btn.addEventListener("click", () => {
          appState.view = btn.dataset.view;
          setActiveTab(appState.view);
          apply();
        });
      });
      dom.tbody.addEventListener("click", e => {
        const tr = e.target.closest("tr");
        if (!tr) return;
        const id = Number(tr.dataset.id);

        const baseList = getFilteredBaseList();
        let rows = compute(baseList, appState.prime, appState.view);
        if (appState.nameAsc) {
          rows = rows
            .slice()
            .sort((a,b)=>a.nom.localeCompare(b.nom))
            .map((x,i)=>({ ...x, rank:i+1 }));
        }
        selectRowById(id, rows);
      });

      if (dom.themeToggle){
        dom.themeToggle.addEventListener("click", () => {
          const current = document.body.dataset.theme || "dark";
          const next = current === "dark" ? "light" : "dark";
          applyTheme(next);
        });
      }
    }

    function init() {
      initTheme();
      initPromosSelect();
      initInputsFromState();
      bindEvents();
      apply();
    }

    init();
  })();
  </script>
</body>
</html>

